"use client";

import { useEffect, useState } from 'react';
import { db } from '@/lib/firebase';
import { collection, query, where, onSnapshot, doc, getDoc } from 'firebase/firestore';
import { useParams } from 'next/navigation';
import Link from 'next/link';
import Image from 'next/image';

export default function VehicleGaragePage() {
  const params = useParams();
  const vehicleId = params?.vehicleId;
  const [vehicle, setVehicle] = useState(null);
  const [items, setItems] = useState([]);
  const [garageExpenses, setGarageExpenses] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!vehicleId) return;
    const vRef = doc(db, 'vehicles', vehicleId);
    getDoc(vRef).then(snap => { if (snap.exists()) setVehicle({ id: snap.id, ...snap.data() }); });

    const q = query(collection(db, 'maintenances'), where('type', '==', 'garage'), where('vehicleId', '==', vehicleId));
    const unsub = onSnapshot(q, snap => {
      const arr = snap.docs.map(d => ({ id: d.id, ...d.data(), source: 'maintenances' }));
      arr.sort((a,b)=>{
        const at = a.createdAt?.seconds ? a.createdAt.seconds*1000 : a.createdAt ? new Date(a.createdAt).getTime() : 0;
        const bt = b.createdAt?.seconds ? b.createdAt.seconds*1000 : b.createdAt ? new Date(b.createdAt).getTime() : 0;
        return bt - at;
      });
      setItems(arr);
    });

    // ‡∏î‡∏∂‡∏á expenses ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏π‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏ó‡∏£‡∏¥‡∏õ)
    const fetchGarageExpenses = async () => {
      try {
        const bookingsSnap = await (await import('firebase/firestore')).getDocs(
          query(collection(db, 'bookings'), where('vehicleId', '==', vehicleId))
        );
        const bookingsMap = {};
        bookingsSnap.docs.forEach(d => {
          bookingsMap[d.id] = d.data();
        });
        const bookingIds = Object.keys(bookingsMap);

        if (bookingIds.length === 0) {
          setGarageExpenses([]);
          setLoading(false);
          return;
        }

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ expenses ‡∏ó‡∏µ‡πà note ‡∏´‡∏£‡∏∑‡∏≠ vendor ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏π‡πà
        const expensesSnap = await (await import('firebase/firestore')).getDocs(
          collection(db, 'expenses')
        );
        const garageExps = expensesSnap.docs
          .map(d => ({ 
            id: d.id, 
            ...d.data(), 
            source: 'expenses',
            bookingData: bookingsMap[d.data().bookingId] // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• booking ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢
          }))
          .filter(exp => {
            if (!bookingIds.includes(exp.bookingId)) return false;
            const note = (exp.note || '').toLowerCase();
            const vendor = (exp.vendor || '').toLowerCase();
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏≠‡∏π‡πà" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ã‡πà‡∏≠‡∏°" ‡∏´‡∏£‡∏∑‡∏≠ "garage" ‡∏´‡∏£‡∏∑‡∏≠ "repair"
            return note.includes('‡∏≠‡∏π‡πà') || note.includes('‡∏ã‡πà‡∏≠‡∏°') || note.includes('garage') || note.includes('repair') ||
                   vendor.includes('‡∏≠‡∏π‡πà') || vendor.includes('garage');
          });

        setGarageExpenses(garageExps);
      } catch (e) {
        console.error('Error fetching garage expenses:', e);
      }
      setLoading(false);
    };

    fetchGarageExpenses();

    return () => unsub();
  }, [vehicleId]);

  // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å maintenances ‡πÅ‡∏•‡∏∞ expenses
  const allItems = [
    ...items,
    ...garageExpenses.map(exp => {
      // ‡πÉ‡∏ä‡πâ startDateTime ‡∏à‡∏≤‡∏Å booking ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      let createdAt = exp.bookingData?.startDateTime;
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ startDateTime ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ createdAt ‡∏´‡∏£‡∏∑‡∏≠ date
      if (!createdAt) createdAt = exp.createdAt || exp.date;
      // ‡∏ñ‡πâ‡∏≤ createdAt ‡πÄ‡∏õ‡πá‡∏ô string ‡πÉ‡∏´‡πâ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Date object
      if (createdAt && typeof createdAt === 'string') createdAt = new Date(createdAt);
      return {
        id: exp.id,
        vendor: exp.vendor || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
        details: exp.note || '-',
        odometerAtDropOff: exp.mileage || null,
        finalMileage: null,
        maintenanceStatus: 'recorded',
        createdAt,
        cost: exp.amount || 0,
        finalCost: exp.amount || 0,
        source: 'expenses'
      };
    })
  ].sort((a, b) => {
    const at = a.createdAt?.seconds ? a.createdAt.seconds*1000 : (a.createdAt ? new Date(a.createdAt).getTime() : 0);
    const bt = b.createdAt?.seconds ? b.createdAt.seconds*1000 : (b.createdAt ? new Date(b.createdAt).getTime() : 0);
    return bt - at;
  });

  if (!vehicleId) return <p className="p-6">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ</p>;
  if (loading) return <p className="p-6">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°...</p>;
  // compute total maintenance cost for this vehicle (use finalCost when present, fallback to cost)
  const totalCost = allItems.reduce((sum, it) => {
    const c = Number(it.finalCost ?? it.cost ?? 0) || 0;
    return sum + c;
  }, 0);

  const translateStatus = (s) => {
    if (!s) return '-';
    switch (s) {
      case 'pending': return '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
      case 'in_progress': return '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°';
      case 'completed': return '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
      case 'cancelled': return '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
      default: return s;
    }
  };

  return (
    <div className="max-w-5xl mx-auto p-6">
      <div className="flex items-center justify-between mb-4">
        <h1 className="text-2xl font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ</h1>
        {vehicle && (
          <div className="flex items-center gap-3 text-sm text-gray-600">
              <div className="w-16 h-16 bg-gray-100 rounded-md overflow-hidden flex-shrink-0">
              {(vehicle.imageUrl || vehicle.photoURL || vehicle.image) ? (
                <Image
                  src={vehicle.imageUrl || vehicle.photoURL || vehicle.image}
                  alt={`${vehicle.brand || ''} ${vehicle.model || ''}`}
                  width={64}
                  height={64}
                  className="object-cover"
                  unoptimized
                />
              ) : (
                <div className="w-full h-full flex items-center justify-center text-2xl">üöó</div>
              )}
            </div>
            <div className="leading-tight">
              <div className="font-semibold">{vehicle.brand} {vehicle.model}</div>
              <div className="text-xs">{vehicle.licensePlate}</div>
            </div>
          </div>
        )}
      </div>

      <div className="mb-4 flex items-center justify-between">
        <div className="text-sm">‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span className="font-semibold">{totalCost.toLocaleString('th-TH')} ‡∏ö‡∏≤‡∏ó</span></div>
      </div>

      {allItems.length === 0 ? (
        <p className="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
      ) : (
        <div className="space-y-4">
          {allItems.map(rec => {
            const sourceBadge = rec.source === 'expenses' ? (
              <span className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded">‡∏à‡∏≤‡∏Å‡∏ó‡∏£‡∏¥‡∏õ</span>
            ) : null;
            
            return (
              <div key={rec.id} className="bg-white rounded-lg shadow p-4">
                <div className="flex justify-between">
                  <div>
                    <div className="flex items-center gap-2">
                      <div className="font-semibold">‡∏≠‡∏π‡πà: {rec.vendor ?? '-'}</div>
                      {sourceBadge}
                    </div>
                    <div className="text-sm text-gray-600">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: {rec.details ?? '-'}</div>
                    <div className="mt-2 text-sm">‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á: {rec.odometerAtDropOff ?? rec.mileage ?? '-'}</div>
                    <div className="mt-2 text-sm">‡πÑ‡∏°‡∏•‡πå‡∏ï‡∏≠‡∏ô‡∏£‡∏±‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ): {rec.finalMileage ?? '-'}</div>
                  </div>
                  <div className="text-right text-sm text-gray-600">
                    <div className="mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: {translateStatus(rec.maintenanceStatus)}</div>
                    <div className="mb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠: {rec.createdAt ? (rec.createdAt.seconds ? new Date(rec.createdAt.seconds*1000).toLocaleString('th-TH') : new Date(rec.createdAt).toLocaleString('th-TH')) : '-'}</div>
                    <div className="mb-1">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô/‡∏à‡∏£‡∏¥‡∏á): {rec.cost ? `${Number(rec.cost).toLocaleString('th-TH')} ‡∏ö‡∏≤‡∏ó` : '-'} / {rec.finalCost ? `${Number(rec.finalCost).toLocaleString('th-TH')} ‡∏ö‡∏≤‡∏ó` : '-'}</div>
                    {rec.source === 'maintenances' && (
                      <>
                        <div className="mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà: {rec.partsUsed ?? '-'}</div>
                        {rec.invoiceNumber && (
                          <div className="mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ: {rec.invoiceNumber}</div>
                        )}
                        <div className="mb-1">‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô: {rec.warranty ? '‡πÉ‡∏ä‡πà' : '‡πÑ‡∏°‡πà'}</div>
                        {rec.warranty && rec.warrantyDate && (
                          <div className="mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô: {rec.warrantyDate.seconds ? new Date(rec.warrantyDate.seconds*1000).toLocaleDateString('th-TH') : new Date(rec.warrantyDate).toLocaleDateString('th-TH')}</div>
                        )}
                        {rec.receivedAt && <div className="text-xs text-gray-500">‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô: {rec.receivedAt.seconds ? new Date(rec.receivedAt.seconds*1000).toLocaleString('th-TH') : new Date(rec.receivedAt).toLocaleString('th-TH')}</div>}
                      </>
                    )}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}
