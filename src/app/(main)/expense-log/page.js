"use client";

import { useState, useEffect } from "react";
import { useAuth } from "@/context/AuthContext";
import { useRouter } from "next/navigation";

export default function ExpenseLogPage() {
  const { user, userProfile } = useAuth();
  const router = useRouter();
  const [activeUsage, setActiveUsage] = useState(null);
  const [loading, setLoading] = useState(true);
  const [type, setType] = useState("fuel");
  const [amount, setAmount] = useState("");
  const [mileage, setMileage] = useState("");
  const [note, setNote] = useState("");
  const [message, setMessage] = useState("");
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [lastFuelMileage, setLastFuelMileage] = useState(null);

  // Fetch active vehicle usage
  useEffect(() => {
    if (!user && !userProfile) return;

    const fetchActiveUsage = async () => {
      try {
        const userId = userProfile?.lineId || user?.uid;
        const response = await fetch(`/api/vehicle-usage/active?userId=${userId}`);
        const result = await response.json();

        if (result.success && result.usage) {
          setActiveUsage(result.usage);
          
          // Fetch expenses to get last fuel mileage
          const expensesResponse = await fetch(`/api/expenses?usageId=${result.usage.id}`);
          const expensesResult = await expensesResponse.json();
          
          if (expensesResult.success && expensesResult.expenses) {
            // ‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            const fuelExpenses = expensesResult.expenses
              .filter(exp => exp.type === 'fuel' && exp.mileage)
              .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (fuelExpenses.length > 0) {
              const lastMileage = fuelExpenses[0].mileage;
              setLastFuelMileage(lastMileage);
              setMileage(lastMileage.toString());
            } else if (result.usage.startMileage) {
              // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏•‡∏¢ ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
              setLastFuelMileage(result.usage.startMileage);
              setMileage(result.usage.startMileage.toString());
            }
          } else if (result.usage.startMileage) {
            setLastFuelMileage(result.usage.startMileage);
            setMileage(result.usage.startMileage.toString());
          }
        } else {
          // No active usage - redirect back
          setMessage("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
          setTimeout(() => router.push('/my-vehicle'), 2000);
        }
        setLoading(false);
      } catch (error) {
        console.error("Error fetching active usage:", error);
        setLoading(false);
      }
    };

    fetchActiveUsage();
  }, [user, userProfile, router]);

  const handleSubmit = async (e) => {
    e.preventDefault();

    if (!amount || Number(amount) <= 0) {
      setMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      return;
    }

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå
    if (type === "fuel" && (!mileage || Number(mileage) <= 0)) {
      setMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô");
      return;
    }

    if (!activeUsage) {
      setMessage("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏ñ");
      return;
    }

    setIsSubmitting(true);
    setMessage("");

    try {
      const userId = userProfile?.lineId || user?.uid;
      const response = await fetch('/api/expenses', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          usageId: activeUsage.id,
          vehicleId: activeUsage.vehicleId,
          userId: userId,
          type,
          amount: Number(amount),
          mileage: mileage ? Number(mileage) : null,
          note: note || '',
        }),
      });

      const result = await response.json();

      if (!response.ok) {
        setMessage(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢');
        setIsSubmitting(false);
        return;
      }

      setMessage("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
      
      // Reset form
      setAmount("");
      setNote("");
      setIsSubmitting(false);

      // Navigate back to my-vehicle page
      setTimeout(() => {
        router.push('/my-vehicle');
      }, 1500);
      
    } catch (error) {
      console.error("Error submitting expense:", error);
      setMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢");
      setIsSubmitting(false);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-teal-600 mx-auto mb-4"></div>
          <p className="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <div className="bg-gradient-to-r from-teal-500 to-teal-600 text-white p-6 pb-24">
        <div className="flex items-center gap-3 mb-2">
          <button onClick={() => router.back()} className="p-2 hover:bg-white/20 rounded-lg">
            <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
            </svg>
          </button>
          <h1 className="text-2xl font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h1>
        </div>
        <p className="text-teal-100 text-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ</p>
      </div>

      {/* Content */}
      <div className="px-4 -mt-16">
        <div className="bg-white rounded-2xl shadow-sm overflow-hidden">
          <form onSubmit={handleSubmit} className="p-6 space-y-4">
            
            {/* Vehicle Info */}
            {activeUsage && (
              <div className="bg-teal-50 border border-teal-200 rounded-lg p-4 mb-4">
                <div className="flex items-center gap-2 mb-2">
                  <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                  <span className="text-sm font-medium text-teal-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                </div>
                <p className="font-semibold text-teal-900">{activeUsage.vehicleLicensePlate}</p>
                {lastFuelMileage && (
                  <p className="text-sm text-teal-700">
                    ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: {lastFuelMileage.toLocaleString()} ‡∏Å‡∏°.
                  </p>
                )}
              </div>
            )}

            {/* ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ <span className="text-red-500">*</span>
              </label>
              <div className="grid grid-cols-2 gap-3">
                <button
                  type="button"
                  onClick={() => setType("fuel")}
                  className={`p-4 border-2 rounded-lg text-center transition-all ${
                    type === "fuel"
                      ? "border-teal-500 bg-teal-50 text-teal-700"
                      : "border-gray-300 hover:border-teal-300"
                  }`}
                >
                  <div className="text-3xl mb-2">‚õΩ</div>
                  <div className="font-medium">‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</div>
                </button>
                <button
                  type="button"
                  onClick={() => setType("other")}
                  className={`p-4 border-2 rounded-lg text-center transition-all ${
                    type === "other"
                      ? "border-teal-500 bg-teal-50 text-teal-700"
                      : "border-gray-300 hover:border-teal-300"
                  }`}
                >
                  <div className="text-3xl mb-2">üí∞</div>
                  <div className="font-medium">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div>
                </button>
              </div>
            </div>

            {/* ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó) <span className="text-red-500">*</span>
              </label>
              <input
                type="number"
                value={amount}
                onChange={(e) => setAmount(e.target.value)}
                placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"
                step="0.01"
                min="0"
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                required
              />
            </div>

            {/* ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô) */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô {type === "fuel" && <span className="text-red-500">*</span>}
              </label>
              <div className="flex gap-2">
                <input
                  type="number"
                  value={mileage}
                  onChange={(e) => setMileage(e.target.value)}
                  placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"
                  className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                  required={type === "fuel"}
                />
                <button
                  type="button"
                  onClick={() => {
                    if (lastFuelMileage) {
                      setMileage(lastFuelMileage.toString());
                    } else if (activeUsage?.startMileage) {
                      setMileage(activeUsage.startMileage.toString());
                    }
                  }}
                  className="px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all whitespace-nowrap"
                  title="‡πÅ‡∏™‡∏Å‡∏ô‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏à‡∏≤‡∏Å‡∏£‡∏ñ"
                >
                  üì∏ ‡πÅ‡∏™‡∏Å‡∏ô
                </button>
              </div>
              <p className="text-xs text-gray-500 mt-1">
                {type === "fuel" 
                  ? "‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô - ‡∏Å‡∏î‡πÅ‡∏™‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î"
                  : "‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö - ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô"
                }
              </p>
            </div>

            {/* ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
              </label>
              <textarea
                value={note}
                onChange={(e) => setNote(e.target.value)}
                placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô, ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô"
                rows="3"
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 resize-none"
              />
            </div>

            {message && (
              <div className={`p-3 rounded-lg text-sm text-center ${
                message.includes('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à') 
                  ? 'bg-green-100 text-green-700' 
                  : 'bg-red-100 text-red-700'
              }`}>
                {message}
              </div>
            )}

            <button
              type="submit"
              disabled={isSubmitting || !amount || (type === "fuel" && !mileage)}
              className="w-full py-3 bg-teal-600 text-white rounded-lg font-semibold hover:bg-teal-700 transition-all disabled:bg-gray-400 disabled:cursor-not-allowed"
            >
              {isSubmitting ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢'}
            </button>
          </form>
        </div>

        {/* Info Card */}
        <div className="mt-6 bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
          <div className="flex items-start gap-3">
            <svg className="w-6 h-6 text-blue-600 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div className="text-sm text-blue-800">
              <p className="font-semibold mb-1">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</p>
              <ul className="list-disc list-inside space-y-1 text-blue-700">
                <li>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</li>
                <li>‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö ‡πÅ‡∏ï‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</li>
                <li>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</li>
                <li>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
